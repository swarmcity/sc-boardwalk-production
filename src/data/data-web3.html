<!--
@license
Copyright (c) 2017 Swarm City
This code may only be used under the license found at https://github.com/swarmcity/license
-->
<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<script src="../swarm-city.min.js" async></script>

<!--
An element that provides simple access to web3 services

HTML Example:
```
<data-web3 id="web3"></data-web3>
```
JS Example
```
this.$.web3.hashtags()
.then((hashtags) => {
    console.log(hashtags) 
})
```
-->

<dom-module id="data-web3">
    <script>
        class DataWeb3 extends Polymer.Element {
            static get is() {
                return 'data-web3';
            }

            /**
             * Returns an array with the deals for a hashtag
             * @return {hashtags} hashtags is an array of objects
             * @param {hashtagID} hashtagID for which to return deals for
             */
            deals(hashtagID) {
                return new Promise((resolve, reject) => {
                    const fakeResponse1 = {
                        name: 'pioneer',
                        id: '8317d4c60a2fc3f1d586d2ca9d66b52f80a013c1',
                        location: '9q8yfr43d4',
                        deals: 230,
                        description: 'pioneer is the first amazing hashtag',
                        maintainer: 'pioneer is maintained by the hashtag commision',
                        contact: [{
                                name: 'twitter',
                                link: 'http://www.twitter.com/@pioneer',
                            },
                            {
                                name: 'facebook',
                                link: 'http://www.facebook.com/pioneer',
                            },
                        ],
                        items: [{
                                DealID: '1317d4c60a2fc3f1d586d2ca9d66b52f80a013c1',
                                location: '3q8yfr43d4',
                                time: 1500530604,
                                username: 'Arian Bronson',
                                reputation: 12,
                                avatar:
                                'QmTWh9FwdByJ15TiqVrgrHchaxrtT3WKRHGpnXe8GXzM7o',
                                description: 'Ride from literton buss stop to protest',
                                value: 5,
                                offers: 3,
                            },
                            {
                                DealID: '1317d4c60a2fc3f1d586d2ca9d66b52f80a013c2',
                                location: '3q8yfr43d5',
                                time: 1500530604,
                                username: 'James Smith',
                                reputation: 13,
                                avatar:
                                'QmTWh9FwdByJ15TiqVrgrHchaxrtT3WKRHGpnXe8GXzM7o',
                                description: 'Ride from literton buss stop to protest',
                                value: 2,
                                offers: 0,
                            },
                        ],
                    };

                    const fakeResponse2 = {
                        name: 'needaride',
                        id: '8317d4c60a2fc3f1d586d2ca9d66b52f80a013c2',
                        location: '9q8yfr43d4',
                        deals: 230,
                        description: 'needaride is the first amazing hashtag',
                        maintainer: 'needaride is maintained by the hashtag commision',
                        contact: [{
                                name: 'twitter',
                                link: 'http://www.twitter.com/@pneedaride',
                            },
                            {
                                name: 'facebook',
                                link: 'http://www.facebook.com/needaride',
                            },
                        ],
                        items: [{
                            DealID: '1317d4c60a2fc3f1d586d2ca9d66b52f80a013c1',
                            location: '3q8yfr43d4',
                            time: 1500530604,
                            username: 'Arian Bronson',
                            reputation: 12,
                            avatar: 'QmTWh9FwdByJ15TiqVrgrHchaxrtT3WKRHGpnXe8GXzM7o',
                            description: 'Ride from literton buss stop to protest',
                            value: 5,
                            offers: 3,
                        }],
                    };

                    const fakeResponse3 = {
                        name: 'swarmbnb',
                        id: '8317d4c60a2fc3f1d586d2ca9d66b52f80a013c3',
                        location: '9q8yfr43d4',
                        deals: 230,
                        description: 'swarmbnb is the first amazing hashtag',
                        maintainer: 'swarmbnb is maintained by the hashtag commision',
                        contact: [{
                                name: 'twitter',
                                link: 'http://www.twitter.com/@pswarmbnb',
                            },
                            {
                                name: 'facebook',
                                link: 'http://www.facebook.com/swarmbnb',
                            },
                        ],
                        items: [{
                                DealID: '1317d4c60a2fc3f1d586d2ca9d66b52f80a013c1',
                                location: '3q8yfr43d4',
                                time: 1500530604,
                                username: 'Arian Bronson',
                                reputation: 12,
                                avatar:
                                'QmTWh9FwdByJ15TiqVrgrHchaxrtT3WKRHGpnXe8GXzM7o',
                                description: '2 Beds in London',
                                value: 5,
                                offers: 3,
                            },
                            {
                                DealID: '1317d4c60a2fc3f1d586d2ca9d66b52f80a013c2',
                                location: '3q8yfr43d5',
                                time: 1500530604,
                                username: 'James Smith',
                                reputation: 13,
                                avatar:
                                'QmTWh9FwdByJ15TiqVrgrHchaxrtT3WKRHGpnXe8GXzM7o',
                                description: '1 Room in Fji',
                                value: 2,
                                offers: 0,
                            },
                            {
                                DealID: '1317d4c60a2fc3f1d586d2ca9d66b52f80a013c2',
                                location: '3q8yfr43d5',
                                time: 1500530604,
                                username: 'James Smith',
                                reputation: 13,
                                avatar:
                                'QmTWh9FwdByJ15TiqVrgrHchaxrtT3WKRHGpnXe8GXzM7o',
                                description: 'Full house in New York',
                                value: 2,
                                offers: 0,
                            },
                        ],
                    };

                    const fakeResponse4 = {
                        name: 'dev',
                        id: '8317d4c60a2fc3f1d586d2ca9d66b52f80a013c4',
                        location: '9q8yfr43d4',
                        deals: 230,
                        description: 'dev is the first amazing hashtag',
                        maintainer: 'dev is maintained by the hashtag commision',
                        contact: [{
                                name: 'twitter',
                                link: 'http://www.twitter.com/@dev',
                            },
                            {
                                name: 'facebook',
                                link: 'http://www.facebook.com/dev',
                            },
                        ],
                        items: [{
                                DealID: '1317d4c60a2fc3f1d586d2ca9d66b52f80a013c1',
                                location: '3q8yfr43d4',
                                time: 1500530604,
                                username: 'Arian Bronson',
                                reputation: 12,
                                avatar:
                                'QmTWh9FwdByJ15TiqVrgrHchaxrtT3WKRHGpnXe8GXzM7o',
                                description: 'Write me 5 unit tests',
                                value: 5,
                                offers: 3,
                            },
                            {
                                DealID: '1317d4c60a2fc3f1d586d2ca9d66b52f80a013c2',
                                location: '3q8yfr43d5',
                                time: 1500530604,
                                username: 'James Smith',
                                reputation: 13,
                                avatar:
                                'QmTWh9FwdByJ15TiqVrgrHchaxrtT3WKRHGpnXe8GXzM7o',
                                description: 'Test this on all mobile devices',
                                value: 2,
                                offers: 0,
                            },
                        ],
                    };

                    if (hashtagID == '8317d4c60a2fc3f1d586d2ca9d66b52f80a013c1') {
                        resolve(fakeResponse1);
                    }
                    if (hashtagID == '8317d4c60a2fc3f1d586d2ca9d66b52f80a013c2') {
                        resolve(fakeResponse2);
                    }
                    if (hashtagID == '8317d4c60a2fc3f1d586d2ca9d66b52f80a013c3') {
                        resolve(fakeResponse3);
                    }
                    if (hashtagID == '8317d4c60a2fc3f1d586d2ca9d66b52f80a013c4') {
                        resolve(fakeResponse4);
                    }
                });
            }

            /**
             * Returns a balance fir thge given address and token pair
             * @param {string} address
             * @param {string} token such as 'SWT' or 'ARC'
             * @return {number} hashtags is an array of objects
             */
            getBalance(address, token) {
                return new Promise((resolve, reject) => {
                    resolve(24.349821);
                });
            }
            /**
             * Returns an array with the hashtag name and
             * @return {hashtags} hashtags is an array of objects
             */
            hashtags() {
                return new Promise((resolve, reject) => {
                    const fakeResponse = [{
                            name: 'pioneer',
                            hashtagID: '8317d4c60a2fc3f1d586d2ca9d66b52f80a013c1',
                            location: '9q8yf253d4',
                            deals: 200,
                            description: 'pioneer is the first amazing hashtag',
                        },
                        {
                            name: 'needaride',
                            hashtagID: '8317d4c60a2fc3f1d586d2ca9d66b52f80a013c2',
                            location: '9q8yf253d4',
                            deals: 180,
                            description: 'get around the city with ease',
                        },
                        {
                            name: 'swarmbnb',
                            hashtagID: '8317d4c60a2fc3f1d586d2ca9d66b52f80a013c3',
                            location: '9q8yf253d4',
                            deals: 150,
                            description: 'get a room in the city',
                        },
                        {
                            name: 'dev',
                            hashtagID: '8317d4c60a2fc3f1d586d2ca9d66b52f80a013c4',
                            location: '9q8yf253d4',
                            deals: 101,
                            description: 'a test hashtag for the devs',
                        },
                        {
                            name: 'needaride',
                            hashtagID: '8317d4c60a2fc3f1d586d2ca9d66b52f80a013c2',
                            location: '9q8yf253d4',
                            deals: 180,
                            description: 'get around the city with ease',
                        },
                        {
                            name: 'swarmbnb',
                            hashtagID: '8317d4c60a2fc3f1d586d2ca9d66b52f80a013c3',
                            location: '9q8yf253d4',
                            deals: 150,
                            description: 'get a room in the city',
                        },
                        {
                            name: 'dev',
                            hashtagID: '8317d4c60a2fc3f1d586d2ca9d66b52f80a013c4',
                            location: '9q8yf253d4',
                            deals: 101,
                            description: 'a test hashtag for the devs',
                        },
                        {
                            name: 'needaride',
                            hashtagID: '8317d4c60a2fc3f1d586d2ca9d66b52f80a013c2',
                            location: '9q8yf253d4',
                            deals: 180,
                            description: 'get around the city with ease',
                        },
                        {
                            name: 'swarmbnb',
                            hashtagID: '8317d4c60a2fc3f1d586d2ca9d66b52f80a013c3',
                            location: '9q8yf253d4',
                            deals: 150,
                            description: 'get a room in the city',
                        },
                        {
                            name: 'dev',
                            hashtagID: '8317d4c60a2fc3f1d586d2ca9d66b52f80a013c4',
                            location: '9q8yf253d4',
                            deals: 101,
                            description: 'a test hashtag for the devs',
                        },
                        {
                            name: 'needaride',
                            hashtagID: '8317d4c60a2fc3f1d586d2ca9d66b52f80a013c2',
                            location: '9q8yf253d4',
                            deals: 180,
                            description: 'get around the city with ease',
                        },
                        {
                            name: 'swarmbnb',
                            hashtagID: '8317d4c60a2fc3f1d586d2ca9d66b52f80a013c3',
                            location: '9q8yf253d4',
                            deals: 150,
                            description: 'get a room in the city',
                        },
                        {
                            name: 'dev',
                            hashtagID: '8317d4c60a2fc3f1d586d2ca9d66b52f80a013c4',
                            location: '9q8yf253d4',
                            deals: 101,
                            description: 'a test hashtag for the devs',
                        },
                        {
                            name: 'needaride',
                            hashtagID: '8317d4c60a2fc3f1d586d2ca9d66b52f80a013c2',
                            location: '9q8yf253d4',
                            deals: 180,
                            description: 'get around the city with ease',
                        },
                        {
                            name: 'swarmbnb',
                            hashtagID: '8317d4c60a2fc3f1d586d2ca9d66b52f80a013c3',
                            location: '9q8yf253d4',
                            deals: 150,
                            description: 'get a room in the city',
                        },
                        {
                            name: 'dev',
                            hashtagID: '8317d4c60a2fc3f1d586d2ca9d66b52f80a013c4',
                            location: '9q8yf253d4',
                            deals: 101,
                            description: 'a test hashtag for the devs',
                        },
                        {
                            name: 'needaride',
                            hashtagID: '8317d4c60a2fc3f1d586d2ca9d66b52f80a013c2',
                            location: '9q8yf253d4',
                            deals: 180,
                            description: 'get around the city with ease',
                        },
                        {
                            name: 'swarmbnb',
                            hashtagID: '8317d4c60a2fc3f1d586d2ca9d66b52f80a013c3',
                            location: '9q8yf253d4',
                            deals: 150,
                            description: 'get a room in the city',
                        },
                        {
                            name: 'dev',
                            hashtagID: '8317d4c60a2fc3f1d586d2ca9d66b52f80a013c4',
                            location: '9q8yf253d4',
                            deals: 101,
                            description: 'a test hashtag for the devs',
                        },
                        {
                            name: 'needaride',
                            hashtagID: '8317d4c60a2fc3f1d586d2ca9d66b52f80a013c2',
                            location: '9q8yf253d4',
                            deals: 180,
                            description: 'get around the city with ease',
                        },
                        {
                            name: 'swarmbnb',
                            hashtagID: '8317d4c60a2fc3f1d586d2ca9d66b52f80a013c3',
                            location: '9q8yf253d4',
                            deals: 150,
                            description: 'get a room in the city',
                        },
                        {
                            name: 'dev',
                            hashtagID: '8317d4c60a2fc3f1d586d2ca9d66b52f80a013c4',
                            location: '9q8yf253d4',
                            deals: 101,
                            description: 'a test hashtag for the devs',
                        },
                        {
                            name: 'needaride',
                            hashtagID: '8317d4c60a2fc3f1d586d2ca9d66b52f80a013c2',
                            location: '9q8yf253d4',
                            deals: 180,
                            description: 'get around the city with ease',
                        },
                        {
                            name: 'swarmbnb',
                            hashtagID: '8317d4c60a2fc3f1d586d2ca9d66b52f80a013c3',
                            location: '9q8yf253d4',
                            deals: 150,
                            description: 'get a room in the city',
                        },
                        {
                            name: 'dev',
                            hashtagID: '8317d4c60a2fc3f1d586d2ca9d66b52f80a013c4',
                            location: '9q8yf253d4',
                            deals: 101,
                            description: 'a test hashtag for the devs',
                        },
                        {
                            name: 'dev',
                            hashtagID: '8317d4c60a2fc3f1d586d2ca9d66b52f80a013c4',
                            location: '9q8yf253d4',
                            deals: 101,
                            description: 'a test hashtag for the devs',
                        },
                        {
                            name: 'dev',
                            hashtagID: '8317d4c60a2fc3f1d586d2ca9d66b52f80a013c4',
                            location: '9q8yf253d4',
                            deals: 101,
                            description: 'a test hashtag for the devs',
                        },
                        {
                            name: 'dev',
                            hashtagID: '8317d4c60a2fc3f1d586d2ca9d66b52f80a013c4',
                            location: '9q8yf253d4',
                            deals: 101,
                            description: 'a test hashtag for the devs',
                        },
                        {
                            name: 'dev',
                            hashtagID: '8317d4c60a2fc3f1d586d2ca9d66b52f80a013c4',
                            location: '9q8yf253d4',
                            deals: 101,
                            description: 'a test hashtag for the devs',
                        },
                        {
                            name: 'dev',
                            hashtagID: '8317d4c60a2fc3f1d586d2ca9d66b52f80a013c4',
                            location: '9q8yf253d4',
                            deals: 101,
                            description: 'a test hashtag for the devs',
                        },
                        {
                            name: 'dev',
                            hashtagID: '8317d4c60a2fc3f1d586d2ca9d66b52f80a013c4',
                            location: '9q8yf253d4',
                            deals: 101,
                            description: 'a test hashtag for the devs',
                        },
                        {
                            name: 'dev',
                            hashtagID: '8317d4c60a2fc3f1d586d2ca9d66b52f80a013c4',
                            location: '9q8yf253d4',
                            deals: 101,
                            description: 'a test hashtag for the devs',
                        },
                    ];
                    resolve(fakeResponse);
                });
            }

            /**
             * Returns an ipfsAddress given a HashtagAddress
             * @param {string} contractName The contract where the lookup is queried
             * @param {string} lookupHashtag the address of the hashtag to get the
             * metadata ipfs address for
             * @return {ipfsAddress} ipfsAddress is a string
             */
            _getHashTagIpfsTag(contractName, lookupHashtag) {
                return new Promise((resolve, reject) => {
                    Promise.all(
                            [this._loadAbi(contractName),
                                this._loadAddress(contractName),
                                this._loadProviders(),
                            ]
                        ).then((data) => {
                            // constructing contract from 
                            // abi/address should happen globally
                            const abiArray = data[0].abi;
                            const contractAddress = data[1][contractName];
                            const providers = data[2]['ropsten'];
                            let web3 = new swarmCity.Web3();
                            web3.setProvider(new web3.providers
                                .HttpProvider(providers[1]));
                            let contract = web3.eth.contract(abiArray)
                                .at(contractAddress);
                            contract.getMap(lookupHashtag, function(error, response) {
                                if (error) {
                                    reject(error);
                                } else {
                                    resolve(response);
                                }
                            });
                        })
                        .catch((err) => {
                            reject(err);
                        });
                });
            }


            /**
             * Returns the abi for the requests contract
             * @param {string} contractName is the name of the contract
             * @return {abi} abiu repreents the contracts abi
             */
            _loadAbi(contractName) {
                return new Promise((resolve, reject) => {
                    const xobj = new XMLHttpRequest();
                    const path = '../src/contracts/' + contractName + '.json';
                    xobj.overrideMimeType('application/json');
                    xobj.open('GET', path, true);
                    xobj.onreadystatechange = () => {
                        if (xobj.readyState == 4 && xobj.status == '200') {
                            const json = JSON.parse(xobj.responseText);
                            resolve(json);
                        }
                    };
                    // Request the json
                    xobj.send(null);
                });
            }

            /**
             * Returns the contract address
             * @param {string} contractName is the name of the contract
             * @return {string} contractAddress repreents the
             * contracts address on main-net
             */
            _loadAddress(contractName) {
                return new Promise((resolve, reject) => {
                    const xobj = new XMLHttpRequest();
                    const path = '../src/contracts/index.json';
                    xobj.overrideMimeType('application/json');
                    xobj.open('GET', path, true);
                    xobj.onreadystatechange = () => {
                        if (xobj.readyState == 4 && xobj.status == '200') {
                            const json = JSON.parse(xobj.responseText);
                            resolve(json);
                        }
                    };
                    // Request the json
                    xobj.send(null);
                });
            }

            /**
             * Returns the web3 providers
             * @param {string} network limit to a network
             * @return {array} providers
             */
            _loadProviders() {
                return new Promise((resolve, reject) => {
                    const xobj = new XMLHttpRequest();
                    const path = '../src/contracts/providers.json';
                    xobj.overrideMimeType('application/json');
                    xobj.open('GET', path, true);
                    xobj.onreadystatechange = () => {
                        if (xobj.readyState == 4 && xobj.status == '200') {
                            const json = JSON.parse(xobj.responseText);
                            resolve(json['web3']);
                        }
                    };
                    // Request the json
                    xobj.send(null);
                });
            }
        }
        window.customElements.define(DataWeb3.is, DataWeb3);
    </script>
</dom-module>